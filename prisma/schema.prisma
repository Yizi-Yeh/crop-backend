generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CalendarFileType {
  ORIGINAL
  COPY
}

enum StageStatus {
  DRAFT
  COMPLETE
}

enum ThresholdOperator {
  GT
  LT
  GTE
  LTE
}

enum Decade {
  UPPER
  MIDDLE
  LOWER
}

// ─── 作物 ───

model Crop {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(100)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

// calendars Calendar[]：這個模型有一對多關係，Calendar 會透過外鍵指向這個模型（例如 Crop 的所有 Calendar）。
  calendars Calendar[]

// @@index([name])，代表這個欄位可能是常用查詢條件。
  @@index([name])
}

// ─── 建立者 ───

model Creator {
  id        String   @id @default(uuid())
  name      String
  role      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  calendars Calendar[]
}

// ─── 栽培曆 ───

model Calendar {
  id               String           @id @default(uuid())
  cropId           String
  creatorId        String
  sourceCalendarId String?
  title            String           @db.VarChar(200)
  zoneName         String           @default("")
  isShared         Boolean          @default(false)
  isPublished      Boolean          @default(false)
  fileType         CalendarFileType @default(ORIGINAL)
  allowCenterUse   Boolean          @default(false)
  sharedAt         DateTime?
  publishedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  crop           Crop               @relation(fields: [cropId], references: [id], onDelete: Cascade)
  creator        Creator            @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  sourceCalendar Calendar?          @relation("CalendarCopy", fields: [sourceCalendarId], references: [id], onDelete: SetNull)
  copy           Calendar?          @relation("CalendarCopy")
  stages         Stage[]
  districts      CalendarDistrict[]

  @@index([cropId, isShared])
  @@index([isPublished, createdAt(sort: Desc)])
  @@index([creatorId])
  @@unique([sourceCalendarId])
}

// ─── 栽培曆地區 ───

model City {
  id   String @id
  name String

  districts         District[]
  calendarDistricts CalendarDistrict[]
}

model District {
  id     String @id
  cityId String
  name   String

  city              City               @relation(fields: [cityId], references: [id], onDelete: Cascade)
  calendarDistricts CalendarDistrict[]
}

model CalendarDistrict {
  calendarId String
  cityId     String
  districtId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  calendar Calendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  city     City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  district District @relation(fields: [districtId], references: [id], onDelete: Cascade)

  @@id([calendarId, cityId, districtId])
}

// ─── 生長期 ───

model Stage {
  id             String      @id @default(uuid())
  calendarId     String
  name           String
  description    String?
  startMonth     String?
  startDecade    Decade?
  endMonth       String?
  endDecade      Decade?
  color          String      @default("")
  status         StageStatus @default(DRAFT)
  coverUrl       String?
  coverName      String?
  coverThumbnail String?
  coverSource    String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  calendar   Calendar         @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  thresholds StageThreshold[]
  albums     StageAlbum[]

  @@index([calendarId])
}

// ─── 生長期相簿 ───

model StageAlbum {
  id        String   @id @default(uuid())
  stageId   String
  url       String
  name      String?
  thumbnail String?
  source    String?  @default("")
  sortOrder String   @default("0")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stage Stage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@index([stageId])
}

// ─── 門檻臨界值 ───

model StageThreshold {
  id           String            @id @default(uuid())
  stageId      String
  indicatorId  String
  operator     ThresholdOperator
  value        Float
  durationDays String            @default("1")
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  stage     Stage     @relation(fields: [stageId], references: [id], onDelete: Cascade)
  indicator Indicator @relation(fields: [indicatorId], references: [id], onDelete: Cascade)

  @@index([stageId])
}

// ─── 指標 ───

model IndicatorCategory {
  id        String   @id @default(uuid())
  name      String   @unique @db.VarChar(50)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  indicators Indicator[]
}

model Indicator {
  id         String   @id @default(uuid())
  categoryId String
  name       String   @db.VarChar(100)
  source     String   @default("")
  unit       String   @db.VarChar(20)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  category   IndicatorCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  thresholds StageThreshold[]

  @@index([categoryId, name])
}

// ─── 溫度上升情境 ───

model Gwl {
  id   String @id @default(uuid())
  name String
}
